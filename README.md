# Обучение LoRA-адаптера для диффузионной модели
Автор - Панченко Василий Игоревич 

### Постановка задачи
Задача проекта - обучить LoRA для базовой диффузионной модели, чтобы она могла хорошо генерировать какой-то конкретный объект. 

### Формат входных и выходных данных
На вход подаются 50+ фотографий объекта в масштабом 512х512, сделанные на телефон в формате `.HEIC`.

### Метрики
Основные метрики во время обучения модели - Loss для текстового энкодера, Loss для эмбедингов обучения, Loss текстового энкодера LoRA, Loss общих градиентов, Loss UNet LoRA, Loss Curve. Также будут передаваться данные нагрузки машины, на которой будет считаться проект.

### Эксперименты будут оцениваться с помощью следующих метрик: 
Dino. Ожидается в районе 0.6 - 0.8, как у оригинальной диффузионной модели. Выбор метрики связан с пониманием классов. Метрика устойчива к стилевым изменениям. 
Text_sim. Чем больше тем лучше. Метрика оценивает соответствие текстовому описанию.

### Валидация и тест
Предполагается разбиение на тренировочный и валидационный выборки в пропорциях 80:20. Для воспроизводимости результата, фотографии будут записаны на яндекс диске, а инструкции по запуску обучения и прогноза модели будут прописаны в `README.md`. 

### Датасеты
Основной датасет будет состоять из 50-200 фотографий одного объекта с разным фоном, ракурсом и расположением объекта. Также необходимо добавить текстовое описание в файл `captions.txt` к каждой фотографии, а объект обозначить через метку `sksToy`. 
Для лучшего результата обучения модели важно, чтобы входные данные были разнообразными, иначе модель быстро переобучится, и также важно следить за качеством описания фотографий.
Пример входных данных без обработки:
https://disk.360.yandex.ru/d/d_2ADwdTPRPs8A 
Пример входных данных с текстовым описанием на вход модели:
https://disk.360.yandex.ru/d/a2_bgE1W3E_rqA

### Моделирование

### Бейзлайн
Запуск базовой диффузионной модели по промту, где обязательно будет слово sksToy в промте. Модель изначально не знает такого слова и будет показывать только шум, если в промте будет только это слово, или же будет опираться на другие слова в промте игнорируя ключевое слово. 

### Основная модель
Главная модель в проекте основана на архитектуре Stable Diffusion с применением метода LoRA (Low-Rank Adaptation) для эффективной дообучения. Модель использует диффузионный процесс для генерации изображений из текстовых описаний через U-Net архитектуру с механизмом внимания. Обучение проводится методом fine-tuning с замороженными весами базовой модели и обучением только низкоранговых адаптеров LoRA, что значительно сокращает вычислительные затраты.
Система поддерживает как Stable Diffusion 1.x, так и SDXL, автоматически определяя архитектуру на основе конфигурации модели. Для валидации используются метрики качества генерации и визуальная оценка сгенерированных изображений, что позволяет контролировать процесс обучения и сохранять лучшие веса.

### Внедрение
Проект реализован на базе Hydra для управления конфигурациями экспериментов. Интеграция с ClearML позволяет автоматически отслеживать метрики, артефакты и сгенерированные изображения в реальном времени. Код поддерживает распределенное обучение и может быть развернут в вычислительной среде института AIRI для проведения масштабных экспериментов.

## Setup

   ```sh
   git git@github.com:PanchenkoVI/lora_diffusion.git
   cd /lora_diffusion
   ```

1. **Start:** 

   ```sh
    
    python3.9 -m venv venv
  
    source venv/bin/activate

    pip install --upgrade pip

    pip install poetry

    poetry install

    poetry run pre-commit install
    
    poetry run pre-commit run -a
   ```